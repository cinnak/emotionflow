<!DOCTYPE html>
<html>
<head>
  <title>Particle Test</title>
  <style>
    body { margin: 0; background: #0d1219; min-height: 100vh; overflow: hidden; }
    #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; }
    #info { position: fixed; top: 20px; left: 20px; color: white; font-family: monospace; z-index: 400; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="info">
    <h2>Particle System Test</h2>
    <button onclick="testParticles()">Test Text Particles</button>
    <p id="status">Click button to test</p>
  </div>
  <canvas id="particleCanvas"></canvas>

  <script>
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');

    // Set canvas size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      console.log('Canvas size:', canvas.width, 'x', canvas.height);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Color palettes (simplified)
    const PALETTE = {
      peak: '#f0805a',
      journey: ['#6c2a2a', '#a03030', '#c04040', '#f0805a', '#ffb080', '#ffdcc7']
    };

    // Particle class (from app.js)
    class Particle {
      constructor(x, y, emotion, palette) {
        this.x = x;
        this.y = y;
        this.originX = x;
        this.originY = y;
        this.emotion = emotion;
        this.palette = palette;

        this.vx = 0;
        this.vy = 0;
        this.gravity = 0.15;
        this.friction = 0.99;

        this.size = 4 + Math.random() * 3;
        this.baseSize = this.size;
        this.life = 1.0;
        this.decay = 0.003 + Math.random() * 0.003;
        this.color = palette.peak;
        this.colorIndex = 0;
        this.journey = palette.journey;

        this.phase = 'holding';
        this.delay = Math.random() * 500;
      }

      explode() {
        this.phase = 'exploding';
        const power = 12 + Math.random() * 20;
        const angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(angle) * power;
        this.vy = Math.sin(angle) * power - 3;
        this.decay = 0.012 + Math.random() * 0.008;
      }

      update() {
        if (this.phase === 'holding') {
          this.delay -= 16;
          if (this.delay <= 0) {
            this.explode();
          }
          return true;
        }

        if (this.phase === 'exploding') {
          this.vy += this.gravity;
          this.vx *= this.friction;
          this.x += this.vx;
          this.y += this.vy;
          this.life -= this.decay;
        }

        const progress = 1 - this.life;
        this.colorIndex = Math.floor(progress * (this.journey.length - 1));
        this.colorIndex = Math.min(this.colorIndex, this.journey.length - 1);

        return this.life > 0;
      }

      draw(ctx) {
        ctx.fillStyle = this.journey[this.colorIndex];
        ctx.globalAlpha = this.life;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function testParticles() {
      document.getElementById('status').textContent = 'Creating particles...';
      console.log('Test started');

      const text = 'TEST';
      const particles = [];

      // Create offscreen canvas for text
      const offCanvas = document.createElement('canvas');
      const offCtx = offCanvas.getContext('2d');
      offCanvas.width = canvas.width;
      offCanvas.height = canvas.height;

      // Draw text
      const fontSize = 64;
      offCtx.font = '600 ' + fontSize + 'px "Inter", sans-serif';
      offCtx.fillStyle = '#ffffff';
      offCtx.textAlign = 'center';
      offCtx.textBaseline = 'middle';
      offCtx.fillText(text, canvas.width / 2, canvas.height / 2);

      // Sample pixels
      const imageData = offCtx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      const gap = 5;

      for (let y = 0; y < canvas.height; y += gap) {
        for (let x = 0; x < canvas.width; x += gap) {
          const index = (y * canvas.width + x) * 4;
          if (pixels[index + 3] > 128) {
            particles.push(new Particle(x, y, 'anger', PALETTE));
          }
        }
      }

      console.log('Created ' + particles.length + ' particles from text: "' + text + '"');
      document.getElementById('status').textContent = 'Created ' + particles.length + ' particles - animating...';

      let frameCount = 0;
      function animate() {
        frameCount++;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (frameCount % 30 === 0) {
          console.log('Drawing ' + particles.length + ' particles');
        }

        particles.forEach((p, i) => {
          const alive = p.update();
          if (alive && p.life > 0) {
            p.draw(ctx);
          }
        });

        ctx.globalAlpha = 1;

        const hasAliveParticles = particles.some(p => p.life > 0);
        if (hasAliveParticles) {
          requestAnimationFrame(animate);
        } else {
          console.log('Animation complete after ' + frameCount + ' frames');
          document.getElementById('status').textContent = 'Animation complete!';
        }
      }

      animate();
    }

    console.log('Particle test loaded. Canvas ready.');
  </script>
</body>
</html>