<!DOCTYPE html>
<html>
<head>
  <title>EmotionFlow Debug Test</title>
  <style>
    body { margin: 0; background: #0d1219; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: monospace; }
    #info { color: white; padding: 20px; text-align: center; }
    #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; pointer-events: none; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px; }
    #log { color: #0f0; font-size: 12px; max-width: 600px; max-height: 200px; overflow-y: auto; background: #000; padding: 10px; }
  </style>
</head>
<body>
  <div id="info">
    <h2>Particle System Debug Test</h2>
    <button onclick="testBasic()">Test Basic Circle</button>
    <button onclick="testTextParticles()">Test Text Particles</button>
    <p id="status">Click a button to test</p>
    <div id="log"></div>
  </div>
  <canvas id="particleCanvas"></canvas>

  <script>
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    const logDiv = document.getElementById('log');

    function log(msg) {
      console.log(msg);
      logDiv.innerHTML += msg + '<br>';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Set canvas size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      log(`Canvas size: ${canvas.width}x${canvas.height}`);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Test 1: Basic circle particles
    function testBasic() {
      log('=== Test Basic Circle Particles ===');
      document.getElementById('status').textContent = 'Testing basic particles...';

      const particles = [];
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      for (let i = 0; i < 100; i++) {
        const angle = (i / 100) * Math.PI * 2;
        particles.push({
          x: centerX,
          y: centerY,
          vx: Math.cos(angle) * 8,
          vy: Math.sin(angle) * 8,
          size: 6,
          color: `hsl(${30 + Math.random() * 30}, 80%, 60%)`,
          life: 1
        });
      }

      log(`Created ${particles.length} particles`);

      function animate() {
        ctx.fillStyle = 'rgba(13, 18, 25, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let alive = false;
        particles.forEach(p => {
          if (p.life > 0) {
            alive = true;
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2;
            p.life -= 0.01;

            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
          }
        });

        ctx.globalAlpha = 1;
        if (alive) {
          requestAnimationFrame(animate);
        } else {
          log('Basic animation complete');
          document.getElementById('status').textContent = 'Basic test complete';
        }
      }
      animate();
    }

    // Test 2: Text to particles (like the real app)
    function testTextParticles() {
      log('=== Test Text to Particles ===');
      document.getElementById('status').textContent = 'Testing text particles...';

      const text = 'TEST';
      const particles = [];

      // Create offscreen canvas for text
      const offCanvas = document.createElement('canvas');
      const offCtx = offCanvas.getContext('2d');
      offCanvas.width = canvas.width;
      offCanvas.height = canvas.height;

      // Draw text
      const fontSize = 64;
      offCtx.font = `600 ${fontSize}px "Inter", sans-serif`;
      offCtx.fillStyle = '#ffffff';
      offCtx.textAlign = 'center';
      offCtx.textBaseline = 'middle';
      offCtx.fillText(text, canvas.width / 2, canvas.height / 2);

      // Sample pixels
      const imageData = offCtx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      const gap = 5;

      for (let y = 0; y < canvas.height; y += gap) {
        for (let x = 0; x < canvas.width; x += gap) {
          const index = (y * canvas.width + x) * 4;
          if (pixels[index + 3] > 128) {
            particles.push({
              x: x,
              y: y,
              originX: x,
              originY: y,
              vx: 0,
              vy: 0,
              size: 5,
              color: `hsl(${30 + Math.random() * 30}, 80%, 60%)`,
              life: 1,
              phase: 'holding',
              delay: Math.random() * 500
            });
          }
        }
      }

      log(`Created ${particles.length} particles from text "${text}"`);

      // Explode after 1 second
      setTimeout(() => {
        log('Exploding particles!');
        particles.forEach(p => {
          const angle = Math.random() * Math.PI * 2;
          const speed = 3 + Math.random() * 8;
          p.vx = Math.cos(angle) * speed;
          p.vy = Math.sin(angle) * speed - 2;
          p.phase = 'exploding';
        });
      }, 1000);

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let alive = false;
        particles.forEach(p => {
          // Update
          if (p.phase === 'holding') {
            p.delay -= 16;
            if (p.delay <= 0) {
              const angle = Math.random() * Math.PI * 2;
              const speed = 3 + Math.random() * 8;
              p.vx = Math.cos(angle) * speed;
              p.vy = Math.sin(angle) * speed - 2;
              p.phase = 'exploding';
            }
          }

          if (p.phase === 'exploding') {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2;
            p.life -= 0.005;
          }

          if (p.life > 0) {
            alive = true;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
          }
        });

        ctx.globalAlpha = 1;
        if (alive) {
          requestAnimationFrame(animate);
        } else {
          log('Text particle animation complete');
          document.getElementById('status').textContent = 'Text test complete';
        }
      }
      animate();
    }

    log('Debug test loaded. Canvas ready.');
  </script>
</body>
</html>
